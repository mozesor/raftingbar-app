<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>רפטינג בר - דוחות</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #111;
      text-align: center;
      direction: rtl;
      padding: 20px;
    }
    .chip.active, .btn.active { outline: 2px solid #2563eb; }
  </style>
</head>
<body>
  <h1>דוח שעות עובדים</h1>
  <div style="margin:20px;">
    <button class="btn">💼 (זוגות) כניסות↔יציאות</button>
    <button class="btn">🚪 מכניסה ראשונה עד יציאה אחרונה</button>
    <div id="rbModeBadge" style="margin-top:10px;"></div>
  </div>
  <button id="runReport" class="btn" style="background:#2563eb;color:white;padding:10px 20px;border-radius:10px;">הצג דוח</button>
  <script>
  /* RB FINAL: מצב חישוב יציב + הזרקת mode לבקשות + רענון דוח בלי ניווט/Reload */
  (function () {
    const LS_KEY  = 'rb_calc_mode';
    const MODE_MAP = { pairs: 'SUM_PAIRS', span: 'FIRST_LAST' };

    try { if (!localStorage.getItem(LS_KEY)) localStorage.setItem(LS_KEY, 'pairs'); } catch(e){}

    if (!window.__rbFetchPatchedFinal) {
      window.__rbFetchPatchedFinal = true;
      const _fetch = window.fetch;
      window.fetch = function (input, init) {
        try {
          const req = (typeof input === 'string') ? new Request(input, init) : input;
          const url = new URL(req.url, location.href);
          if ((/script\.google(?:usercontent)?\.com$/i).test(url.hostname) && url.pathname.includes('/macros/')) {
            const m = (localStorage.getItem(LS_KEY) || 'pairs');
            if (!url.searchParams.has('mode')) {
              url.searchParams.set('mode', MODE_MAP[m] || 'SUM_PAIRS');
            }
            url.searchParams.set('_ts', String(Date.now()));
            const init2 = Object.assign({ cache: 'no-store' }, init || {});
            const req2  = new Request(url.toString(), init2);
            return _fetch.call(this, req2);
          }
        } catch (e) {}
        return _fetch.call(this, input, init);
      };
    }

    function clickRun() {
      const runBtn = document.getElementById('runReport');
      if (runBtn) runBtn.textContent = "🔄 טוען דוח...";
      setTimeout(() => { if (runBtn) runBtn.textContent = "הצג דוח"; }, 1200);
      console.log("📊 נשלח דוח עם מצב:", localStorage.getItem(LS_KEY));
    }

    function setMode(newMode){
      try { localStorage.setItem(LS_KEY, newMode); } catch(e){}
      paintActive();
      setTimeout(clickRun, 10);
    }

    document.addEventListener('click', function(ev){
      const el  = ev.target.closest('button, .chip, .btn');
      if (!el) return;
      const txt = (el.textContent || '').trim();
      if (/כניסות.?↔.?יציאות|זוגות/.test(txt))      setMode('pairs');
      else if (/כניסה\s*ראשונה/.test(txt))          setMode('span');
    }, true);

    function paintActive(){
      const chips = document.querySelectorAll('.btn');
      const m = localStorage.getItem(LS_KEY) || 'pairs';
      chips.forEach(c=>c.classList.remove('active'));
      if (m==='pairs') chips[0].classList.add('active');
      else chips[1].classList.add('active');
      const badge = document.getElementById('rbModeBadge');
      badge.textContent = (m==='pairs') ? 'מצב חישוב: כניסות↔יציאות (זוגות)' : 'מצב חישוב: כניסה ראשונה → יציאה אחרונה';
    }
    document.addEventListener('DOMContentLoaded', paintActive);
  })();
  </script>
</body>
</html>
