<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<title>רפטינג בר — נוכחות</title>
<style>
  :root{--brand:#2563eb;--muted:#e5e7eb;--ok:#16a34a;--bad:#ef4444}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:#f7f7fb; color:#0f172a}
  header{background:linear-gradient(180deg,#6f6eea,#7c52d9); color:#fff; padding:20px 16px; text-align:center; position:sticky; top:0; z-index:1}
  header .sub{opacity:.9; margin-top:6px}
  .wrap{max-width:1100px; margin:18px auto; padding:0 12px}
  .card{background:#fff; border:1px solid #eef; border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(30,27,75,.06); margin-bottom:16px}
  h2{margin:0 0 12px 0; font-size:20px}
  label{display:block; font-size:14px; margin:8px 0 6px 0; color:#374151}
  select, input[type="date"], input[type="text"]{width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; background:#fff}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .btn{padding:12px 14px; border:none; border-radius:12px; background:var(--brand); color:#fff; font-weight:600; cursor:pointer}
  .btn:disabled{opacity:.6; cursor:default}
  .btn-ghost{background:#fff; color:#111827; border:1px solid var(--muted)}
  .btn-danger{background:var(--bad)}
  .btn-ok{background:var(--ok)}
  .chips{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0}
  .chip{padding:8px 12px; border:1px solid var(--muted); border-radius:999px; background:#fff; cursor:pointer; user-select:none}
  .chip.active{background:var(--brand); color:#fff; border-color:var(--brand)}
  table{width:100%; border-collapse:separate; border-spacing:0 6px}
  th,td{background:#fff; padding:12px; border-top:1px solid #eef; border-bottom:1px solid #eef}
  th{font-weight:700; color:#111827}
  td{color:#111827}
  tr td:first-child, tr th:first-child{border-radius:10px 0 0 10px}
  tr td:last-child, tr th:last-child{border-radius:0 10px 10px 0}
  .muted{color:#6b7280}
  .bar{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .inline{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .pill{padding:6px 8px; background:#ecf3ff; color:#1e40af; border-radius:999px; font-size:13px}
  .notice{padding:10px 12px; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; border-radius:10px; margin:8px 0}
  .danger{background:#fef2f2; color:#7f1d1d; border-color:#fecaca}
  footer{height:60px}
</style>
</head>
<body>

<header>
  <div style="font-size:26px; font-weight:800;">רפטינג בר 🏄‍♂️</div>
  <div class="sub" id="onlineState">מחובר לענן • <span id="clock">--:--</span></div>
</header>

<div class="wrap">

  <!-- רישום נוכחות ידני -->
  <section class="card">
    <h2>רישום נוכחות</h2>
    <div class="row">
      <div>
        <label>בחר עובד</label>
        <select id="empSelectManual"></select>
      </div>
      <div>
        <label>מקור</label>
        <input id="sourceInput" type="text" placeholder="PWA" value="PWA" />
      </div>
    </div>
    <div class="bar" style="margin-top:12px">
      <div class="inline">
        <button id="btnIn"  class="btn btn-ok">כניסה</button>
        <button id="btnOut" class="btn btn-danger">יציאה</button>
      </div>
      <div id="lastMsg" class="muted"></div>
    </div>
  </section>

  <!-- דוחות לעובד -->
  <section class="card">
    <div class="bar">
      <h2>דוח אישי לעובד 👥</h2>
      <div class="inline">
        <span class="muted">מצב חישוב:</span>
        <span id="modeLabel" class="pill">זוגות</span>
      </div>
    </div>

    <div class="row">
      <div>
        <label>בחר עובד</label>
        <select id="empSelectReport"></select>
      </div>
      <div>
        <label>תקופה</label>
        <select id="periodSelect">
          <option value="month" selected>החודש</option>
          <option value="week">השבוע</option>
          <option value="custom">מותאם אישית</option>
        </select>
      </div>
    </div>

    <div id="customRange" class="row" style="margin-top:8px; display:none;">
      <div>
        <label>מתאריך</label>
        <input id="fromDate" type="date" />
      </div>
      <div>
        <label>עד תאריך</label>
        <input id="toDate" type="date" />
      </div>
    </div>

    <div class="chips" id="calcChips">
      <div id="chipPair" class="chip">חישוב: כניסות↔︎יציאות (זוגות)</div>
      <div id="chipSpan" class="chip">חישוב: מכניסה ראשונה עד יציאה אחרונה</div>
      <button id="btnShow" class="btn" style="margin-inline-start:auto">הצג דוח</button>
    </div>

    <div id="saveDefaultWrap" class="inline muted" style="margin:6px 0;">
      <span>Settings: לפי</span>
      <span class="pill">Auto</span>
      <button id="btnSaveDefault" class="btn-ghost">שמור כברירת מחדל לעובד</button>
    </div>

    <div id="summary" class="notice" style="display:none"></div>
    <div class="card" style="padding:0; border:none; box-shadow:none">
      <table id="reportTable">
        <thead><tr><th>תאריך</th><th>כניסה</th><th>יציאה</th><th>שעות</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- הגדרות -->
  <section class="card">
    <h2>הגדרות</h2>
    <div class="row">
      <div>
        <label>Google Sheets API Key (קריאה)</label>
        <input id="apiKeyInput" type="text" placeholder="AIza...." />
      </div>
      <div>
        <label>Apps Script exec URL (כתיבה)</label>
        <input id="execInput" type="text" placeholder="https://script.google.com/macros/s/…/exec" />
      </div>
    </div>
    <div class="bar" style="margin-top:10px">
      <div class="inline">
        <button id="btnSaveSettings" class="btn">שמור</button>
        <button id="btnReloadData" class="btn btn-ghost">טען נתונים מחדש</button>
      </div>
      <div class="muted">sheetId: <span id="sheetIdLabel"></span></div>
    </div>
    <div id="cfgMsg" class="notice" style="display:none"></div>
  </section>

</div>
<footer></footer>

<script>
/* =========================
   CONFIG + STATE
   ========================= */
const DEFAULTS = {
  sheetId: '1SNSdRdJy-vP--spyKmVwDbnaz808KEwTYSKiLreFn0w', // Spreadsheet ID
  apiKey: localStorage.getItem('apiKey') || '',           // set via Settings
  scriptUrl: localStorage.getItem('scriptUrl') || 'https://script.google.com/macros/s/AKfycbyLGONR5WG-mNc8ZLk04grA0WJQsugtoAnY211prkyLAJmO_Iu5wbUVAUuGEMayxAV2/exec'
};
window.sheetId = DEFAULTS.sheetId;
window.apiKey  = DEFAULTS.apiKey;

let employees = [];                    // ['אור','יונתן'...]
let attendanceRaw = {};                // emp -> date -> [{action:'checkin'|'checkout', ts: ISO}]
let currentMode = localStorage.getItem('calcMode') || 'pair'; // 'pair' | 'span'

/* =========================
   UTILS
   ========================= */
function tzFmt(d, fmt='HH:mm'){ // simple hh:mm
  const pad = n => String(n).padStart(2,'0');
  if (!d) return '-';
  const dt = new Date(d);
  if (isNaN(+dt)) return '-';
  if (fmt==='HH:mm') return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  return dt.toISOString();
}
function ymd(d){ const dt = new Date(d); const m=String(dt.getMonth()+1).padStart(2,'0'); const da=String(dt.getDate()).padStart(2,'0'); return `${dt.getFullYear()}-${m}-${da}`; }
function hoursBetween(a,b){ if(!a||!b) return 0; const A=new Date(a), B=new Date(b); const ms=B-A; return ms>0? ms/36e5 : 0; }
function normEvent(a){
  a = String(a||'').toLowerCase();
  if (['in','checkin','check-in','enter','start','arrival','connected','online','join'].includes(a)) return 'checkin';
  if (['out','checkout','check-out','leave','end','exit','disconnect','offline','left'].includes(a)) return 'checkout';
  if (a.indexOf('כניס')>-1) return 'checkin';
  if (a.indexOf('יציא')>-1) return 'checkout';
  return a;
}
function showAlert(msg, type){
  const el = document.getElementById('cfgMsg');
  el.textContent = msg;
  el.style.display = 'block';
  el.className = 'notice' + (type==='error' ? ' danger' : '');
  setTimeout(()=>{el.style.display='none'}, 3000);
}

/* =========================
   CLOCK
   ========================= */
(function tick(){
  const now = new Date();
  document.getElementById('clock').textContent = tzFmt(now);
  requestAnimationFrame(()=>setTimeout(tick, 500));
})();

/* =========================
   LOAD DATA FROM SHEET
   ========================= */
async function loadDataFromSheet(){
  if (!window.apiKey){
    showAlert('לא הוגדר API Key לקריאה — הכנס בהגדרות', 'error');
    return;
  }
  try{
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${window.sheetId}/values/A:F?key=${window.apiKey}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const rows = (data && data.values) ? data.values : [];

    const set = new Set();
    const raw = {};

    for (let i=1;i<rows.length;i++){
      const row = rows[i] || [];
      const emp  = row[0] || '';
      const act  = normEvent(row[1] || '');
      const iso  = row[2] || '';
      const date = row[3] || '';

      if (!emp || !date) continue;
      set.add(emp);

      if (act==='checkin' || act==='checkout'){
        (raw[emp]||(raw[emp]={}))[date] = (raw[emp][date]||[]);
        raw[emp][date].push({action:act, ts:iso});
      }
    }

    employees = Array.from(set).sort();
    attendanceRaw = raw;

    populateEmployeeSelects();
  }catch(err){
    showAlert('שגיאה בטעינת נתונים: '+err.message, 'error');
  }
}

function populateEmployeeSelects(){
  const opts = ['<option value="" disabled selected>בחר</option>'].concat(
    employees.map(n=>`<option>${n}</option>`)
  ).join('');
  document.getElementById('empSelectManual').innerHTML = opts;
  document.getElementById('empSelectReport').innerHTML = opts;
}

/* =========================
   MANUAL CHECKIN / CHECKOUT
   ========================= */
function getExecUrl(){
  return localStorage.getItem('scriptUrl') || DEFAULTS.scriptUrl;
}
function recordToSheet(employee, action, tsISO){
  const url = getExecUrl();
  if (!url){ showAlert('לא הוגדרה כתובת exec', 'error'); return Promise.resolve(false); }
  const iso = tsISO || new Date().toISOString();
  const event = normEvent(action);
  const date = iso.slice(0,10);
  const time = iso.slice(11,19);
  const source = (document.getElementById('sourceInput').value || 'PWA');

  const payload = {
    // גרסה ישנה — כותב ל"גיליון1"
    values: [[ employee, event, iso, date, time, source ]],
    // גרסה חדשה — תאימות
    name: employee, event: event, timestamp: iso, source: 'pwa'
  };
  return fetch(url, {
    method: 'POST',
    mode: 'no-cors',
    headers: {'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  }).then(()=>true).catch(()=>false);
}

/* =========================
   REPORTS (SELF)
   ========================= */
function setMode(mode){
  currentMode = mode; // 'pair' | 'span'
  localStorage.setItem('calcMode', mode);
  document.getElementById('modeLabel').textContent = (mode==='pair'?'זוגות':'מכניסה ראשונה');
  document.getElementById('chipPair').classList.toggle('active', mode==='pair');
  document.getElementById('chipSpan').classList.toggle('active', mode==='span');
}

function calcDay(rawList){
  const arr = (rawList||[]).slice().sort((a,b)=>String(a.ts||'').localeCompare(String(b.ts||'')));
  let firstIn=null, lastOut=null, open=null, sum=0;

  for (const ev of arr){
    if (ev.action==='checkin'){
      if (!firstIn) firstIn = ev.ts;
      if (!open) open = ev.ts;
    } else if (ev.action==='checkout'){
      lastOut = ev.ts;
      if (open){ sum += hoursBetween(open, ev.ts); open=null; }
    }
  }

  let hours=0, incomplete=false;
  if (currentMode==='span'){
    hours = hoursBetween(firstIn, lastOut);
    incomplete = !(firstIn && lastOut);
  } else {
    hours = sum;
    incomplete = !!open;
  }
  return {hours: Math.round(hours*100)/100, firstIn, lastOut, incomplete};
}

function buildRange(){
  const period = document.getElementById('periodSelect').value;
  const now = new Date();
  let start, end;
  if (period==='week'){
    const day = (now.getDay()+6)%7;
    start = new Date(now); start.setDate(now.getDate()-day); start.setHours(0,0,0,0);
    end   = new Date(now); end.setHours(23,59,59,999);
  } else if (period==='custom'){
    const from = document.getElementById('fromDate').value;
    const to   = document.getElementById('toDate').value;
    start = from ? new Date(from+'T00:00:00') : new Date(now.getFullYear(), now.getMonth(), 1);
    end   = to   ? new Date(to  +'T23:59:59') : new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1);
    end   = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);
  }
  const dates=[]; for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) dates.push( ymd(d) );
  return {start, end, dates};
}

function renderReport(){
  const emp = document.getElementById('empSelectReport').value;
  if (!emp){ showAlert('בחר עובד לדוח', 'error'); return; }

  const {dates} = buildRange();
  const tbody = document.querySelector('#reportTable tbody');
  tbody.innerHTML = '';
  let total=0, days=0;

  for (const dateKey of dates){
    const rawList = attendanceRaw && attendanceRaw[emp] && attendanceRaw[emp][dateKey];
    const res = calcDay(rawList);
    const h = Number(res.hours||0);
    if (h>0){ days++; total += h; }
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dateKey.split('-').reverse().join('/')}</td>
      <td>${tzFmt(res.firstIn)}</td>
      <td>${tzFmt(res.lastOut)}</td>
      <td>${h.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  const sum = document.getElementById('summary');
  sum.style.display = 'block';
  sum.textContent = `סה״כ שעות: ${total.toFixed(2)} • ימי עבודה: ${days} • מצב חישוב: ${currentMode==='pair'?'זוגות':'מכניסה ראשונה'}`;
}

/* =========================
   SETTINGS UI
   ========================= */
function initSettings(){
  document.getElementById('sheetIdLabel').textContent = DEFAULTS.sheetId;
  document.getElementById('apiKeyInput').value = window.apiKey || '';
  document.getElementById('execInput').value   = getExecUrl();

  document.getElementById('btnSaveSettings').onclick = ()=>{
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const exec   = document.getElementById('execInput').value.trim();
    if (apiKey){ localStorage.setItem('apiKey', apiKey); window.apiKey = apiKey; }
    if (exec){ localStorage.setItem('scriptUrl', exec); }
    showAlert('ההגדרות נשמרו ✔️');
  };
  document.getElementById('btnReloadData').onclick = async()=>{
    await loadDataFromSheet();
    showAlert('הנתונים נטענו מחדש ✔️');
  };
}

/* =========================
   BINDINGS
   ========================= */
window.addEventListener('DOMContentLoaded', ()=>{
  // מצב חישוב
  setMode(currentMode);
  document.getElementById('chipPair').onclick = ()=>setMode('pair');
  document.getElementById('chipSpan').onclick = ()=>setMode('span');

  // תקופה
  document.getElementById('periodSelect').onchange = (e)=>{
    document.getElementById('customRange').style.display = (e.target.value==='custom') ? 'grid' : 'none';
  };

  // כפתור הצגת דוח
  document.getElementById('btnShow').onclick = renderReport;

  // רישום ידני
  document.getElementById('btnIn').onclick = async()=>{
    const emp = document.getElementById('empSelectManual').value;
    if (!emp) return showAlert('בחר עובד', 'error');
    const ok = await recordToSheet(emp, 'checkin');
    document.getElementById('lastMsg').textContent = ok ? `✔ נרשם כניסה עבור ${emp}` : 'שגיאה בשליחה';
    if (ok) { await loadDataFromSheet(); }
  };
  document.getElementById('btnOut').onclick = async()=>{
    const emp = document.getElementById('empSelectManual').value;
    if (!emp) return showAlert('בחר עובד', 'error');
    const ok = await recordToSheet(emp, 'checkout');
    document.getElementById('lastMsg').textContent = ok ? `✔ נרשמה יציאה עבור ${emp}` : 'שגיאה בשליחה';
    if (ok) { await loadDataFromSheet(); }
  };

  // הגדרות
  initSettings();

  // טעינה ראשונית
  loadDataFromSheet();
});
</script>

</body>
</html>
