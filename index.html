<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>רפטינג בר – מערכת נוכחות מלאה</title>
<meta name="theme-color" content="#1677ff">
<style>
  :root { --brand:#1677ff; --bg:#f7f8fa; --card:#fff; --text:#222; --muted:#6b7280; --border:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);padding-bottom:78px}
  .header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px}
  .header h1{margin:0;font-size:18px}
  .sub{color:var(--muted);font-size:12px}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  select,input,button{height:42px;border:1px solid var(--border);border-radius:10px;padding:0 12px;font-size:14px;background:#fff}
  button.btn{background:var(--brand);color:#fff;border:none}
  .btn-ghost{background:#fff}
  .chip{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none}
  .chip.active{border-color:var(--brand);box-shadow:0 0 0 2px rgba(22,119,255,.2) inset}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-top:1px solid var(--border);text-align:center}
  th{background:#fafafa}
  .pill{background:#eef2ff;color:#334155;border-radius:999px;padding:6px 10px;font-size:12px;margin-inline-end:8px}
  .muted{color:var(--muted);font-size:13px}
  .page{display:none}
  .page.active{display:block}
  .nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(5,1fr);height:66px}
  .nav button{border:none;background:#fff;color:#444;font-size:12px}
  .nav button.active{color:#1677ff;font-weight:700}
  .status-badge{padding:4px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
  .in{background:#10b981}.out{background:#ef4444}
</style>
</head>
<body>
  <div class="header">
    <h1>🏄‍♂️ רפטינג בר</h1>
    <div class="sub" id="cloudStatus">מתחבר…</div>
    <div class="sub" style="margin-inline-start:auto" id="clock"></div>
  </div>

  <div class="wrap">
    <!-- בית -->
    <section id="page-home" class="page active">
      <div class="card">
        <h3>רישום נוכחות</h3>
        <div class="row" style="margin-top:8px">
          <select id="sel-emp"></select>
          <button class="btn" id="btn-checkin">🟢 כניסה</button>
          <button class="btn" id="btn-checkout" style="background:#ef4444">🔴 יציאה</button>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="row" style="justify-content:space-between">
            <div><b>מצב נוכחי:</b> <span id="now-state" class="status-badge out">לא במשמרת</span></div>
            <div class="muted">שעות היום: <span id="today-hours">0</span></div>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>אירוע מהיר</h3>
        <div class="row" style="margin-top:8px">
          <input type="date" id="event-date">
          <button class="btn" id="btn-event">➕ הוסף אירוע</button>
        </div>
      </div>
    </section>

    <!-- עובדים -->
    <section id="page-emps" class="page">
      <div class="card">
        <h3>👥 סטטוס עובדים</h3>
        <div id="emp-grid" class="col"></div>
      </div>
    </section>

    <!-- דוח אישי -->
    <section id="page-self" class="page">
      <div class="card">
        <h3>👤 דוח אישי</h3>
        <div class="row">
          <select id="self-emp"></select>
          <select id="self-year"></select>
          <select id="self-month"></select>
        </div>
        <div class="row" style="margin:10px 0">
          <span class="muted">מצב חישוב:</span>
          <div id="chip-fl" class="chip" role="button" aria-pressed="false">כניסה ראשונה⇢יציאה אחרונה</div>
          <div id="chip-pr" class="chip" role="button" aria-pressed="false">זוגות כניסות⇆יציאות</div>
          <button class="btn" id="btn-run" style="margin-inline-start:auto">הצג דוח</button>
        </div>
        <div class="muted" id="self-note"></div>
        <div class="row" style="margin-top:6px">
          <span class="pill" id="ph-total">סה״כ שעות: 0</span>
          <span class="pill" id="ph-days">ימי עבודה: 0</span>
          <span class="muted" id="ph-calc"></span>
        </div>
        <div class="card" style="margin-top:10px">
          <table>
            <thead><tr><th>תאריך</th><th>כניסה</th><th>יציאה</th><th>שעות</th></tr></thead>
            <tbody id="self-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- דוחות מפורטים (תצוגה בסיסית) -->
    <section id="page-detailed" class="page">
      <div class="card">
        <h3>📈 דוחות מפורטים</h3>
        <div class="row">
          <select id="det-emp"><option value="all">כל העובדים</option></select>
          <select id="det-period">
            <option value="today">היום</option>
            <option value="week">השבוע</option>
            <option value="month" selected>החודש</option>
          </select>
          <button class="btn" id="btn-refresh">עדכן</button>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="row"><span class="pill" id="det-hours">סה״כ שעות: 0</span><span class="pill" id="det-events">אירועים: 0</span></div>
          <div class="muted" style="margin-top:6px">* תצוגה בסיסית. אפשר להעמיק בהמשך.</div>
        </div>
      </div>
    </section>

    <!-- ניהול -->
    <section id="page-admin" class="page">
      <div class="card">
        <h3>⚙️ ניהול</h3>
        <div class="row">
          <input id="admin-pass" placeholder="קוד גישה (4–6 ספרות)" maxlength="6">
          <button class="btn" id="btn-set-pass">שנה קוד</button>
          <button class="btn btn-ghost" id="btn-sync">סנכרון</button>
        </div>
        <div class="muted" style="margin-top:6px">שינוי הקוד מתבצע דרך כתיבת שורה ייעודית לגיליון (נשמר בענן).</div>
      </div>
    </section>
  </div>

  <div class="nav">
    <button data-page="home" class="active">🏠 בית</button>
    <button data-page="emps">👥 עובדים</button>
    <button data-page="self">📊 אישי</button>
    <button data-page="detailed">📈 מפורט</button>
    <button data-page="admin">⚙️ ניהול</button>
  </div>

<script>
// ===== קונפיגורציה =====
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_UMxeN_-dYeiR4xQa4HzT9ogZPv8BeYkRuUg0BOeEobOQZJVvj7gZU-2U_5LrxEtK/exec'; // כתובת ה-Web App שלך
const CALC = { FIRST_LAST: 'FIRST_LAST', SUM_PAIRS: 'SUM_PAIRS' };

// ===== מצב אפליקציה =====
let employees = [];              // רשימת עובדים
let attendance = {};            // { [emp]: { [YYYY-MM-DD]: { logs:[{action,ts}] , checkIn, checkOut, events } } }
let statusNow = {};             // { [emp]: 'in' | 'out' }
let settings = { byName:{}, defaultPolicy: CALC.FIRST_LAST };
let adminPassword = '1234';
let currentCalc = CALC.FIRST_LAST;

// ===== UI =====
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);

// ניווט
$$('.nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    $$('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const page = btn.dataset.page;
    $$('.page').forEach(p=>p.classList.remove('active'));
    $('#page-'+page).classList.add('active');
    if (page==='self') ensureSelfDefaults();
  });
});

// שעון
setInterval(()=>{ $('#clock').textContent = new Date().toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}) }, 1000);

// ===== עזרי תאריך/זמן =====
const pad2 = n => String(n).padStart(2,'0');
function todayKey(d=new Date()){ return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate()); }
function fmtHM(d){ return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
function formatDateHeb(s){ if(!s) return ''; const [y,m,d]=s.split('-'); return d+'/'+m; }

// ===== חיבור ל-Settings מה-GAS =====
async function loadSettings(){
  try{
    const r = await fetch(SCRIPT_URL+'?fn=settings');
    const j = await r.json();
    if (j.ok){
      settings = j;
      // בנה רשימת עובדים מתוך Settings (אם קיימת)
      const names = Object.keys(j.byName||{}).sort();
      if (names.length) employees = names;
    }
  }catch(e){}
}

// ===== שליחת שורות לגיליון (doPost) =====
async function postRow(row){
  // row = [Employee, Action, Timestamp(ISO), Date, Time, Source]
  try{
    await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ values:[row] })
    });
    return true;
  }catch(e){ return false; }
}

// ===== רישום כניסה/יציאה/אירוע (לוגיקה מקומית + שליחה) =====
function ensureEmpDay(emp, day){
  attendance[emp] = attendance[emp] || {};
  attendance[emp][day] = attendance[emp][day] || { logs:[] };
  if (!attendance[emp][day].logs) attendance[emp][day].logs = [];
  return attendance[emp][day];
}

async function checkIn(){
  const emp = $('#sel-emp').value;
  if(!emp) return alert('בחר עובד');
  const now = new Date();
  const day = todayKey(now);
  const iso = now.toISOString();
  const time = now.toLocaleTimeString('he-IL');
  const dayObj = ensureEmpDay(emp, day);
  dayObj.checkIn = iso;
  dayObj.logs.push({action:'checkin', ts: iso});
  statusNow[emp] = 'in';
  await postRow([emp,'checkin',iso,day,time,'PWA']);
  renderHome();
}

async function checkOut(){
  const emp = $('#sel-emp').value;
  if(!emp) return alert('בחר עובד');
  if(statusNow[emp]!=='in') return alert('העובד לא במשמרת');
  const now = new Date();
  const day = todayKey(now);
  const iso = now.toISOString();
  const time = now.toLocaleTimeString('he-IL');
  const dayObj = ensureEmpDay(emp, day);
  dayObj.checkOut = iso;
  dayObj.logs.push({action:'checkout', ts: iso});
  statusNow[emp] = 'out';
  await postRow([emp,'checkout',iso,day,time,'PWA']);
  renderHome();
}

async function addEventQuick(){
  const emp = $('#sel-emp').value;
  if(!emp) return alert('בחר עובד');
  const day = $('#event-date').value || todayKey();
  const iso = new Date().toISOString();
  const time = new Date().toLocaleTimeString('he-IL');
  const dayObj = ensureEmpDay(emp, day);
  dayObj.events = (dayObj.events||0) + 1;
  await postRow([emp,'event',iso,day,time,'PWA']);
  renderHome();
}

// ===== חישוב שעות יומיות (FIRST_LAST או PAIRS) =====
function hoursFirstLast(dayObj){
  if(!dayObj || !dayObj.logs) return 0;
  const first = dayObj.logs.find(l=>l.action==='checkin');
  const last  = [...dayObj.logs].reverse().find(l=>l.action==='checkout');
  if(!first || !last) return 0;
  const t1 = new Date(first.ts), t2 = new Date(last.ts);
  if (isNaN(t1) || isNaN(t2) || t2<=t1) return 0;
  return Math.round(((t2 - t1)/36e5)*100)/100;
}
function hoursPairs(dayObj){
  if(!dayObj || !dayObj.logs) return 0;
  let open=null, hrs=0;
  for(const l of dayObj.logs){
    if(l.action==='checkin'){ if(!open) open = new Date(l.ts); }
    else if(l.action==='checkout' && open){ const out=new Date(l.ts); if(out>open) hrs += (out-open)/36e5; open=null; }
  }
  return Math.round(hrs*100)/100;
}
function dayHoursByMode(dayObj){
  return currentCalc===CALC.FIRST_LAST ? hoursFirstLast(dayObj) : hoursPairs(dayObj);
}

// ===== רנדר בית/עובדים =====
function renderHome(){
  // סטטוס
  const emp = $('#sel-emp').value;
  const day = todayKey();
  const dayObj = emp ? (attendance[emp] && attendance[emp][day]) : null;
  const hrs = dayHoursByMode(dayObj);
  $('#today-hours').textContent = (hrs||0).toFixed(2);
  const st = emp ? (statusNow[emp]||'out') : 'out';
  const badge = $('#now-state'); badge.textContent = st==='in'?'במשמרת':'לא במשמרת'; badge.className='status-badge '+(st==='in'?'in':'out');

  // רשת עובדים
  const grid = $('#emp-grid'); if(!grid) return;
  grid.innerHTML = '';
  employees.forEach(name=>{
    const d = attendance[name] && attendance[name][day];
    const h = dayHoursByMode(d);
    const s = statusNow[name]||'out';
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div class="row" style="justify-content:space-between"><b>${name}</b><span class="status-badge ${s==='in'?'in':'out'}">${s==='in'?'במשמרת':'לא במשמרת'}</span></div>
                     <div class="muted">שעות היום: ${(h||0).toFixed(2)}</div>`;
    grid.appendChild(div);
  });
}

// ===== דוח אישי (שולף מהשרת) =====
function ensureSelfDefaults(){
  const now = new Date();
  const y = now.getFullYear();
  const m = pad2(now.getMonth()+1);
  if (!$('#self-year').options.length){
    let years=''; for(let i=y-2;i<=y+1;i++){ years+=`<option ${i===y?'selected':''}>${i}</option>`; }
    $('#self-year').innerHTML = years;
  }
  if (!$('#self-month').options.length){
    let months=''; for(let i=1;i<=12;i++){ months+=`<option value="${pad2(i)}" ${pad2(i)===m?'selected':''}>${pad2(i)}</option>`;}
    $('#self-month').innerHTML = months;
  }
  if (!$('#self-emp').options.length){
    $('#self-emp').innerHTML = employees.map(n=>`<option value="${n}">${n}</option>`).join('');
  }
}

function setCalc(mode){
  currentCalc = mode;
  const fl = $('#chip-fl'), pr = $('#chip-pr');
  const isFL = mode===CALC.FIRST_LAST;
  fl.classList.toggle('active', isFL);
  pr.classList.toggle('active', !isFL);
  fl.setAttribute('aria-pressed', isFL); pr.setAttribute('aria-pressed', !isFL);
}

async function runSelfReport(){
  const emp = $('#self-emp').value;
  if (!emp) return alert('בחר עובד');
  const y = $('#self-year').value;
  const m = $('#self-month').value;
  const url = `${SCRIPT_URL}?report=summary&emp=${encodeURIComponent(emp)}&year=${y}&month=${m}&calc=${currentCalc}`;
  const r = await fetch(url); const j = await r.json();

  $('#ph-total').textContent = 'סה״כ שעות: '+(j.totalHours||0);
  $('#ph-days').textContent  = 'ימי עבודה: '+(j.daysWorked||0);
  $('#ph-calc').textContent  = 'מצב חישוב בפועל: '+(j.calc||currentCalc);
  $('#self-note').textContent = (j.calc==='FIRST_LAST' ? 'החישוב לפי כניסה ראשונה עד יציאה אחרונה.' : 'החישוב לפי זוגות כניסה/יציאה.');

  const tb = $('#self-tbody'); tb.innerHTML = '';
  (j.rows||[]).forEach(rw=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${formatDateHeb(rw.date)}</td><td>${rw.checkin||'-'}</td><td>${rw.checkout||'-'}</td><td>${Number(rw.hours||0).toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
  if (!j.rows || !j.rows.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">אין נתונים לחודש הנבחר.</td></tr>`; }
}

// ===== דוחות מפורטים (בסיסי) =====
function refreshDetailed(){
  // כאן שמרנו תצוגה בסיסית, כי הנתונים המפורטים דורשים שליפה מלאה מהגיליון.
  // אפשרות מינימלית: סכום שעות מתוך הדאטה המקומי לפי טווחים.
  const empVal = $('#det-emp').value;
  const period = $('#det-period').value;
  const end = new Date();
  const start = new Date(end);
  if (period==='today'){}
  else if (period==='week'){ start.setDate(end.getDate()-6); }
  else { start.setDate(1); }

  let total=0, events=0;
  const names = empVal==='all'?employees:[empVal];
  for(const name of names){
    let d = new Date(start);
    while (d<=end){
      const key = todayKey(d);
      const dayObj = attendance[name] && attendance[name][key];
      total += dayHoursByMode(dayObj)||0;
      if (dayObj && dayObj.events) events += dayObj.events;
      d.setDate(d.getDate()+1);
    }
  }
  $('#det-hours').textContent = 'סה״כ שעות: '+ total.toFixed(2);
  $('#det-events').textContent = 'אירועים: '+ events;
}

// ===== ניהול: שינוי קוד =====
async function changeAdminPass(){
  const pass = $('#admin-pass').value.trim();
  if (!/^\d{4,6}$/.test(pass)) return alert('קוד 4–6 ספרות בלבד');
  const now = new Date(); const day = todayKey(now);
  await postRow([pass,'admin_password_change', now.toISOString(), day, now.toLocaleTimeString('he-IL'), 'PWA']);
  adminPassword = pass;
  alert('🔐 הקוד עודכן (ויסונכרן בכל המכשירים).');
}

// ===== אתחול =====
async function init(){
  // תאריך אירוע ברירת מחדל
  $('#event-date').value = todayKey();

  // לחצנים
  $('#btn-checkin').onclick = checkIn;
  $('#btn-checkout').onclick = checkOut;
  $('#btn-event').onclick = addEventQuick;
  $('#chip-fl').onclick = ()=>setCalc(CALC.FIRST_LAST);
  $('#chip-pr').onclick = ()=>setCalc(CALC.SUM_PAIRS);
  $('#btn-run').onclick = runSelfReport;
  $('#btn-refresh').onclick = refreshDetailed;
  $('#btn-set-pass').onclick = changeAdminPass;
  $('#btn-sync').onclick = ()=>alert('סנכרון יתבצע אוטומטית עם רישום פעולות. (שליפה מלאה מגיליון ניתן להוסיף בהמשך)');

  setCalc(CALC.FIRST_LAST);

  // טען הגדרות ושמות עובדים
  await loadSettings();
  // אם אין עובדים ב-Settings, שמור רשימת דמה עד שייכתבו שורות לגיליון
  if (!employees.length) employees = ['אור','דור אבו','יונתן הלל'];

  // בנה סלקטים
  $('#sel-emp').innerHTML   = employees.map(n=>`<option>${n}</option>`).join('');
  $('#self-emp').innerHTML  = employees.map(n=>`<option>${n}</option>`).join('');
  $('#det-emp').innerHTML   = `<option value="all">כל העובדים</option>` + employees.map(n=>`<option value="${n}">${n}</option>`).join('');

  // סטטוס ענן אינדיקטיבי
  $('#cloudStatus').textContent = 'מחובר';
  renderHome();
}
init();
</script>
</body>
</html>
